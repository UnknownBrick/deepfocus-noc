<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noc DeepFocus</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-color: #1a1a1a;       
            --sidebar-bg: #212121;     
            --card-bg: #2a2a2a;        
            --hover-bg: #333333;       
            --text-main: #eeeeee;      
            --text-muted: #999999;     
            --accent: #ffffff;         
            --link-color: #00ffff; 
            --danger-color: #ff4444; 
            --border: #404040;         
        }

        body.matrix-mode {
            --bg-color: #000000 !important;
            --sidebar-bg: #001100 !important;
            --card-bg: #002200 !important;
            --hover-bg: #003300 !important;
            --text-main: #00ff00 !important;
            --text-muted: #008800 !important;
            --accent: #00ff00 !important;
            --link-color: #00ff00 !important;
            --danger-color: #ff0000 !important;
            --border: #005500 !important;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', Courier, monospace; user-select: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            cursor: default;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* LOGIN SCREEN */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            border: 1px solid var(--text-main); padding: 40px; text-align: center;
            box-shadow: 0 0 30px rgba(255,255,255,0.1); width: 400px;
            background: #000;
            position: relative;
            overflow: hidden;
        }
        .login-input {
            background: transparent; border: 1px solid var(--text-muted); color: #fff;
            padding: 10px; width: 100%; margin: 0; font-size: 1.2rem; text-align: center; outline: none;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }
        .login-input:focus { border-color: var(--link-color); box-shadow: 0 0 10px var(--link-color); }
        .login-input:disabled { opacity: 0.5; border-color: #333; cursor: not-allowed; color: #666; }

        .login-btn {
            background: var(--text-main); color: #000; border: none; padding: 10px 30px; margin-top: 15px;
            font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .login-btn:hover { background: #fff; transform: scale(1.02); }
        .login-btn.vanish { opacity: 0; transform: translateY(20px); pointer-events: none; margin-top: -40px; }

        #id-container { position: relative; z-index: 2; transition: 0.3s; margin-bottom: 0; }
        #pass-wrapper {
            overflow: hidden; max-height: 0; opacity: 0; transform: translateY(-10px); 
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); margin-top: 0;
        }
        #pass-wrapper.cloned { max-height: 150px; opacity: 1; transform: translateY(0); margin-top: 15px; }

        /* UI ELEMENTS */
        #trail-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 99990; mix-blend-mode: screen; }
        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            z-index: 200000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.2s;
        }
        #modal-overlay.active { opacity: 1; }
        .modal-box {
            background: var(--bg-color); border: 1px solid var(--text-main); padding: 30px; width: 450px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.9); transform: scale(0.9);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #modal-overlay.active .modal-box { transform: scale(1); }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: var(--text-main); text-transform: uppercase; letter-spacing: 1px; }
        .modal-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 25px; line-height: 1.4; }
        .modal-actions { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .modal-btn { padding: 10px 20px; cursor: pointer; font-weight: bold; font-size: 0.85rem; border: 1px solid var(--text-muted); color: var(--text-muted); background: transparent; transition: 0.2s; }
        .modal-btn:hover { border-color: var(--text-main); color: var(--text-main); transform: translateY(-2px); }

        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column-reverse; gap: 10px; z-index: 100000; pointer-events: none; }
        .toast { background-color: var(--bg-color); border: 1px solid var(--text-main); color: var(--text-main); padding: 10px 20px; font-size: 0.85rem; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: toastIn 0.3s forwards; opacity: 0; display: flex; align-items: center; gap: 10px; min-width: 300px; }
        .toast.hiding { animation: toastOut 0.3s forwards; }
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { to { transform: translateY(10px); opacity: 0; } }

        /* LAYOUT */
        .sidebar { width: 300px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px; z-index: 10; position: relative; transition: background-color 0.5s ease; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        #monthDisplay { font-size: 1rem; font-weight: 700; color: var(--text-main); text-transform: uppercase; letter-spacing: 2px; }
        .nav-btn { cursor: pointer; padding: 5px 10px; font-weight: bold; color: var(--text-muted); transition: color 0.2s; }
        .nav-btn:hover { color: var(--text-main); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-header { text-align: center; font-size: 0.8rem; color: var(--text-main); opacity: 0.8; margin-bottom: 10px; font-weight: bold; }
        .day-wrapper { position: relative; height: 38px; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 4px; transition: all 0.1s; }
        .day-box { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: var(--text-muted); z-index: 2; font-weight: 600; }
        .day-wrapper:hover { background-color: var(--hover-bg); }
        .day-wrapper:hover .day-box { color: var(--text-main); }
        .day-box.active { background-color: var(--text-muted); color: #000; font-weight: bold; border-radius: 4px; }
        .connector-bar { position: absolute; bottom: 4px; height: 2px; background-color: var(--text-main); z-index: 1; }
        .connector-single { width: 4px; height: 4px; bottom: 3px; background-color: var(--text-main); }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; background-color: var(--bg-color); display: flex; flex-direction: column; transition: background-color 0.5s ease; }
        .date-title { font-size: 1.8rem; margin-bottom: 5px; font-weight: bold; color: var(--text-main); text-transform: uppercase; }
        .date-subtitle { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 30px; display: block; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .task-container { display: flex; flex-direction: column; gap: 12px; padding-bottom: 100px; }
        .task-card { background-color: var(--card-bg); border: 1px solid var(--border); padding: 18px; position: relative; transition: all 0.2s; border-radius: 4px; overflow: hidden; }
        .task-card:hover { border-color: var(--text-muted); transform: translateX(5px); }
        .task-card:focus-within { border-color: var(--text-main); background-color: #303030; }
        body.matrix-mode .task-card:focus-within { background-color: #0f3a0f; }

        .shared-badge { position: absolute; top: 8px; right: 12px; font-size: 10px; color: var(--link-color); border: 1px solid var(--link-color); padding: 2px 6px; text-transform: uppercase; letter-spacing: 1px; background: var(--card-bg); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 5; }
        .task-header { display: flex; align-items: center; gap: 12px; position: relative; z-index: 10; }
        .main-checkbox { width: 20px; height: 20px; border: 2px solid var(--text-muted); cursor: pointer; display: grid; place-items: center; flex-shrink: 0; background: transparent; transition: 0.2s; }
        .main-checkbox:hover { border-color: var(--text-main); }
        .main-checkbox.checked { background-color: var(--text-main); border-color: var(--text-main); }
        .main-checkbox.checked::after { content: ''; width: 10px; height: 10px; background-color: #000; }
        .task-title-input { background: transparent; border: none; color: var(--text-main); font-size: 1.1rem; width: 100%; outline: none; }
        .completed .task-title-input { text-decoration: line-through; color: var(--text-muted); opacity: 0.5; }
        
        .subtask-list { margin-left: 30px; padding-left: 15px; border-left: 2px solid #444; display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
        .subtask-item { display: flex; align-items: center; gap: 10px; position: relative; }
        .mini-checkbox { width: 14px; height: 14px; border: 1px solid var(--text-muted); cursor: pointer; display: grid; place-items: center; flex-shrink: 0; }
        .mini-checkbox.checked { background-color: var(--text-muted); }
        .subtask-input { background: transparent; border: none; border-bottom: 1px solid transparent; color: var(--text-muted); width: 100%; outline: none; font-size: 0.95rem; }
        .subtask-input:focus { border-bottom: 1px solid var(--text-main); color: var(--text-main); }
        
        .btn-group { margin-left: auto; display: flex; gap: 10px; align-items: center; }
        .action-btn { background: none; border: none; font-size: 0.9rem; cursor: pointer; opacity: 0; transition: 0.2s; font-weight: bold; position: relative; z-index: 20; }
        .task-card:hover .action-btn { opacity: 1; }
        .delete-btn { color: #555; } .delete-btn:hover { color: #fff; }
        .unlink-btn { color: var(--link-color); margin-top: 1px;} .unlink-btn:hover { text-shadow: 0 0 5px var(--link-color); transform: scale(1.1); }
        .sub-del-btn { margin-left: auto; color: #555; cursor: pointer; opacity: 0; font-size: 0.8rem; padding: 0 5px; font-weight: bold; transition: 0.2s; }
        .subtask-item:hover .sub-del-btn { opacity: 1; } .sub-del-btn:hover { color: #fff; transform: scale(1.2); }

        .fab { position: fixed; bottom: 50px; right: 50px; width: 60px; height: 60px; background: var(--text-main); display: grid; place-items: center; font-size: 30px; color: #000; cursor: pointer; z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); background: #fff; }

        .scramble-text { display: inline-block; min-width: 10px; }
        .logout-btn { color: var(--danger-color); border: 1px solid var(--danger-color); padding: 5px; margin-top: 10px; font-size: 0.7rem; cursor: pointer; text-align: center; width: 100%; }
        .logout-btn:hover { background: var(--danger-color); color: #fff; }

        /* --- CHAT SYSTEM CSS --- */
        .chat-box {
            position: fixed; bottom: 100px; left: 20px; width: 350px; height: 400px;
            background-color: var(--sidebar-bg); border: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 99999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); transition: opacity 0.2s;
        }

        .chat-header {
            background: var(--hover-bg); padding: 10px; border-bottom: 1px solid var(--border);
            cursor: move; font-size: 0.8rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center;
        }
        
        .chat-tabs {
            display: flex; overflow-x: auto; background: #111; border-bottom: 1px solid var(--border); align-items: center;
        }
        .chat-tabs::-webkit-scrollbar { height: 4px; }
        .chat-tabs::-webkit-scrollbar-thumb { background: var(--text-muted); }

        .chat-tab {
            padding: 8px 12px; font-size: 0.75rem; cursor: pointer; color: var(--text-muted);
            border-right: 1px solid #333; white-space: nowrap; display: flex; align-items: center; gap: 5px;
        }
        .chat-tab:hover { background: #222; color: #fff; }
        .chat-tab.active { background: var(--card-bg); color: var(--link-color); font-weight: bold; }
        .chat-tab.alert { color: var(--link-color); animation: flash 1s infinite; }
        
        .chat-close-btn { font-size: 0.7rem; color: #666; font-weight: normal; margin-left: 3px; }
        .chat-close-btn:hover { color: var(--danger-color); }
        
        .add-tab-btn {
            padding: 5px 10px; cursor: pointer; color: var(--link-color); font-weight: bold; font-size: 1.2rem;
            display: grid; place-items: center;
        }
        .add-tab-btn:hover { text-shadow: 0 0 5px var(--link-color); }

        .chat-messages {
            flex: 1; padding: 10px; overflow-y: auto; font-size: 0.8rem;
            display: flex; flex-direction: column; gap: 8px; background: #151515;
        }
        .chat-messages::-webkit-scrollbar { width: 5px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--border); }

        .chat-msg { padding: 5px 8px; border-radius: 4px; max-width: 90%; word-break: break-word; }
        .chat-msg.me { align-self: flex-end; background: var(--text-muted); color: #000; text-align: right; }
        .chat-msg.other { align-self: flex-start; background: #222; border: 1px solid #333; color: var(--text-main); }
        .msg-sender { font-size: 0.65rem; opacity: 0.6; display: block; margin-bottom: 2px; }

        .chat-input-area {
            padding: 8px; border-top: 1px solid var(--border); display: flex; gap: 5px; background: var(--sidebar-bg);
        }
        .chat-input {
            flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 5px; font-size: 0.8rem; outline: none;
        }
        .chat-input:focus { border-color: var(--text-main); }
        .chat-send-btn {
            background: var(--text-main); color: #000; border: none; font-weight: bold; cursor: pointer; padding: 0 10px; font-size: 0.8rem;
        }

        /* ADMIN PANEL */
        #admin-panel {
            display: none; padding: 10px; background: #220000; border-bottom: 1px solid red;
            text-align: center; color: red; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        body.matrix-mode #admin-panel { background: #001100; border-color: #00ff00; color: #00ff00; }
        .user-select { background: #000; color: #fff; border: 1px solid red; padding: 5px; margin-left: 10px; }
        body.matrix-mode .user-select { border-color: #00ff00; color: #00ff00; }

        @keyframes flash { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom: 10px; letter-spacing: 2px;" class="scramble-target">DEEP FOCUS</h2>
            <p style="color: #999; font-size: 0.8rem;">NOCTURNUS DEEPFOCUS</p>
            <div id="id-container">
                <input type="text" id="login-id" class="login-input" placeholder="ENTER ID">
                <button id="id-btn" class="login-btn" onclick="checkID()">NEXT ></button>
            </div>
            <div id="pass-wrapper">
                <input type="password" id="login-pass" class="login-input" placeholder="ACCESS CODE">
                <button class="login-btn" onclick="verifyPassword()">INITIALIZE SYSTEM</button>
            </div>
        </div>
    </div>

    <canvas id="trail-canvas"></canvas>
    <div id="toast-container"></div>

    <div id="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-title">...</div>
            <div class="modal-desc" id="modal-desc">...</div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <div id="chat-box" class="chat-box" style="display:none;">
        <div class="chat-header" id="chat-header">
            <span id="chat-title">:: STUDIO COMMS ::</span>
            <span style="cursor:pointer;" onclick="toggleChat()">[X]</span>
        </div>
        <div class="chat-tabs" id="chat-tabs"></div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chat-input" placeholder="Message..." onkeydown="if(event.key==='Enter') sendChat()">
            <button class="chat-send-btn" onclick="sendChat()">></button>
        </div>
    </div>

    <aside class="sidebar">
        <div class="calendar-header">
            <span class="nav-btn" onmouseenter="SFX.hover()" onclick="SFX.click(); changeMonth(-1)">&lt;</span>
            <span id="monthDisplay" class="scramble-target">...</span>
            <span class="nav-btn" onmouseenter="SFX.hover()" onclick="SFX.click(); changeMonth(1)">&gt;</span>
        </div>
        <div class="calendar-grid" id="calendarGrid" style="margin-bottom: 10px;"></div>
        
        <div style="margin-top: auto; margin-bottom: 10px;">
            <button class="login-btn" style="margin:0; font-size:0.8rem; padding: 5px;" onclick="toggleChat()">[OPEN COMMUNICATOR]</button>
        </div>

        <div>
            <div style="font-size: 0.7rem; color: #555; text-align: center;">
                LOGGED AS: <span id="current-user-display" style="color: #fff;">...</span>
            </div>
            <div class="logout-btn" onclick="logout()">[LOGOUT]</div>
        </div>
    </aside>

    <main class="main-content">
        <div id="admin-panel" style="display:none;">
            <span>⚠️ ADMIN MODE</span>
            <div>
                <select id="user-selector" class="user-select" onchange="switchUserView(this.value)">
                    <option value="">LOADING USERS...</option>
                </select>
                <button onclick="deleteCurrentUser()" style="background:red; color:white; border:none; padding:5px; margin-left:5px; cursor:pointer; font-weight:bold;">[DELETE USER]</button>
            </div>
        </div>

        <h1 class="date-title scramble-target" id="selectedDateDisplay">...</h1>
        <span class="date-subtitle" id="selectedDateSubtitle">...</span>
        <div class="task-container" id="taskContainer"></div>
    </main>

    <div class="fab" onmouseenter="SFX.hover()" onclick="SFX.confirm(); addNewTaskManual()">+</div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCgU19zUSLVSHJSe-0umJISerM1zUR0GRk",
            authDomain: "deepfocus-f8668.firebaseapp.com",
            databaseURL: "https://deepfocus-f8668-default-rtdb.firebaseio.com",
            projectId: "deepfocus-f8668",
            storageBucket: "deepfocus-f8668.firebasestorage.app",
            messagingSenderId: "57788854023",
            appId: "1:57788854023:web:b578dd1b0a6fe17f271fa2",
            measurementId: "G-MR3BMQG1E9"
        };
        const ADMIN_ID = "TUNA";  
        const ADMIN_PASS = "1903";  

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let myID = null;
        let viewingID = null; 
        let db = { tasks: {}, calendar: {} }; 
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentViewDate = new Date();
        
        // CHAT STATE
        let openChatTabs = JSON.parse(localStorage.getItem('nocOpenChatTabs')) || ['general'];
        let currentChatChannel = localStorage.getItem('nocActiveChat') || 'general';
        let unreadCount = 0;
        let chatListeners = {};

        // --- SESSION CONTROL ---
        window.onload = function() {
            const savedID = localStorage.getItem('deepFocusUser');
            if(savedID) {
                myID = savedID;
                completeLogin(savedID);
            }
        };

        function logout() {
            localStorage.removeItem('deepFocusUser');
            localStorage.removeItem('nocOpenChatTabs'); // Opsiyonel: Çıkışta sekmeleri silmek istersen
            location.reload();
        }

        // --- LOGIN FLOW ---
        function checkID() {
            const input = document.getElementById('login-id');
            const val = input.value.trim().toUpperCase();
            if(!val) return;
            
            if(val === ADMIN_ID) {
                input.disabled = true; 
                document.getElementById('id-btn').classList.add('vanish');
                document.getElementById('pass-wrapper').classList.add('cloned'); 
                setTimeout(() => document.getElementById('login-pass').focus(), 400);
                SFX.click();
            } else {
                completeLogin(val);
            }
        }

        function verifyPassword() {
            const pass = document.getElementById('login-pass').value;
            if(pass === ADMIN_PASS) {
                SFX.confirm();
                completeLogin(ADMIN_ID); 
            } else {
                SFX.delete();
                alert("ACCESS DENIED");
                location.reload();
            }
        }

        function completeLogin(id) {
            myID = id;
            viewingID = id;
            localStorage.setItem('deepFocusUser', myID); 
            document.getElementById('current-user-display').innerText = myID;
            document.getElementById('login-overlay').style.display = 'none';
            document.body.classList.remove('matrix-mode');

            if(myID === ADMIN_ID) initAdminPanel();
            listenToData(viewingID);
            initChatSystem();
        }

        // --- DB & CHAT SYSTEM ---
        let dbRef = null;
        function listenToData(targetID) {
            if(dbRef) dbRef.off();
            notify(`SYNCING: ${targetID}...`);
            dbRef = database.ref('users/' + targetID);
            dbRef.on('value', (snapshot) => {
                const val = snapshot.val();
                db = val || { tasks: {}, calendar: {} };
                if(!db.tasks) db.tasks = {};
                if(!db.calendar) db.calendar = {};
                if(document.activeElement.tagName !== 'INPUT') {
                    renderCalendar();
                    renderTasks();
                }
            });
        }
        function saveData() { database.ref('users/' + viewingID).set(db).catch(e => console.error(e)); }

        // --- CHAT LOGIC ---
        function toggleChat() {
            const box = document.getElementById('chat-box');
            if(box.style.display === 'none') {
                box.style.display = 'flex';
                unreadCount = 0; document.title = "Noc DeepFocus"; // Reset notification
                // Scroll to bottom
                const msgCont = document.getElementById('chat-messages');
                msgCont.scrollTop = msgCont.scrollHeight;
            } else {
                box.style.display = 'none';
            }
        }

        function initChatSystem() {
            makeDraggable(document.getElementById('chat-box'));
            renderChatTabs();
            // Start listening to ALL open tabs for notifications
            openChatTabs.forEach(tabUser => setupChatListener(tabUser));
        }

        function setupChatListener(targetUser) {
            if(chatListeners[targetUser]) return; // Already listening
            const channelID = getChannelID(targetUser);
            
            // Listen for last message to trigger notifications
            const ref = database.ref('chats/' + channelID).limitToLast(1);
            ref.on('child_added', (snapshot) => {
                const msg = snapshot.val();
                if(msg && msg.timestamp > Date.now() - 2000) { // Only new messages (2s buffer)
                    if(msg.sender !== myID) {
                        const box = document.getElementById('chat-box');
                        // If chat is hidden OR we are on a different tab
                        if(box.style.display === 'none' || getChannelID(currentChatChannel) !== channelID) {
                            handleNotification(targetUser);
                        }
                    }
                }
            });
            chatListeners[targetUser] = ref;
        }

        function handleNotification(targetUser) {
            SFX.notify();
            unreadCount++;
            document.title = `(${unreadCount}) Noc DeepFocus`;
            // Visually alert tab
            const tabs = document.getElementsByClassName('chat-tab');
            for(let t of tabs) {
                if(t.innerText.includes(targetUser === 'general' ? 'GENERAL' : targetUser)) {
                    t.classList.add('alert');
                }
            }
        }

        function renderChatTabs() {
            const container = document.getElementById('chat-tabs');
            container.innerHTML = '';
            
            openChatTabs.forEach(user => {
                const isGen = user === 'general';
                const label = isGen ? 'GENERAL' : user;
                const chanID = getChannelID(user);
                
                const div = document.createElement('div');
                div.className = `chat-tab ${getChannelID(currentChatChannel) === chanID ? 'active' : ''}`;
                div.onclick = () => switchChatTab(user);
                
                let html = `<span>${label}</span>`;
                if(!isGen) {
                    html += `<span class="chat-close-btn" onclick="closeChatTab(event, '${user}')">x</span>`;
                }
                div.innerHTML = html;
                container.appendChild(div);
            });

            // Add Tab Button
            const addBtn = document.createElement('div');
            addBtn.className = 'add-tab-btn';
            addBtn.innerText = '+';
            addBtn.onclick = openUserListModal;
            container.appendChild(addBtn);

            loadMessages(currentChatChannel);
        }

        function switchChatTab(user) {
            currentChatChannel = user;
            localStorage.setItem('nocActiveChat', user);
            renderChatTabs(); // Re-render to update active class
            
            // Remove alert class
            const tabs = document.getElementsByClassName('chat-tab');
            for(let t of tabs) { if(t.innerText.includes(user)) t.classList.remove('alert'); }
        }

        function closeChatTab(e, user) {
            e.stopPropagation();
            openChatTabs = openChatTabs.filter(u => u !== user);
            localStorage.setItem('nocOpenChatTabs', JSON.stringify(openChatTabs));
            
            // Turn off listener
            if(chatListeners[user]) { chatListeners[user].off(); delete chatListeners[user]; }

            // If closed active tab, switch to general
            if(currentChatChannel === user) {
                currentChatChannel = 'general';
                localStorage.setItem('nocActiveChat', 'general');
            }
            renderChatTabs();
        }

        function openUserListModal() {
            // Fetch users to chat with
            database.ref('users').once('value', snap => {
                const users = snap.val() || {};
                const userList = Object.keys(users).filter(u => u !== myID && !openChatTabs.includes(u));
                
                if(userList.length === 0) {
                    notify("NO NEW USERS FOUND");
                    return;
                }

                const buttons = userList.map(u => ({
                    text: u,
                    action: () => {
                        openChatTabs.push(u);
                        localStorage.setItem('nocOpenChatTabs', JSON.stringify(openChatTabs));
                        setupChatListener(u);
                        switchChatTab(u);
                    }
                }));

                openModal("NEW COMM LINK", "SELECT TARGET:", buttons);
            });
        }

        function getChannelID(user) {
            if(user === 'general') return 'general';
            return [myID, user].sort().join('_');
        }

        function loadMessages(targetUser) {
            const chanID = getChannelID(targetUser);
            const msgContainer = document.getElementById('chat-messages');
            msgContainer.innerHTML = '<div style="color:#555; text-align:center;">LOADING...</div>';
            
            // Detach old main listener (not notification listeners)
            if(window.currentMsgRef) window.currentMsgRef.off();

            window.currentMsgRef = database.ref('chats/' + chanID).limitToLast(50);
            window.currentMsgRef.on('value', snap => {
                msgContainer.innerHTML = '';
                const msgs = snap.val() || {};
                Object.values(msgs).forEach(msg => {
                    const div = document.createElement('div');
                    const isMe = msg.sender === myID;
                    div.className = `chat-msg ${isMe ? 'me' : 'other'}`;
                    div.innerHTML = `<span class="msg-sender">${msg.sender}</span>${msg.text}`;
                    msgContainer.appendChild(div);
                });
                msgContainer.scrollTop = msgContainer.scrollHeight;
            });
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            const chanID = getChannelID(currentChatChannel);
            database.ref('chats/' + chanID).push({
                sender: myID, text: text, timestamp: Date.now()
            });
            input.value = '';
            SFX.click();
        }

        function makeDraggable(elmnt) {
            var pos1=0,pos2=0,pos3=0,pos4=0;
            const header = document.getElementById("chat-header");
            if(header) header.onmousedown = dragMouseDown;
            function dragMouseDown(e) { e=e||window.event; e.preventDefault(); pos3=e.clientX; pos4=e.clientY; document.onmouseup=closeDrag; document.onmousemove=elementDrag; }
            function elementDrag(e) { e=e||window.event; e.preventDefault(); pos1=pos3-e.clientX; pos2=pos4-e.clientY; pos3=e.clientX; pos4=e.clientY; elmnt.style.top=(elmnt.offsetTop-pos2)+"px"; elmnt.style.left=(elmnt.offsetLeft-pos1)+"px"; elmnt.style.bottom="auto"; }
            function closeDrag() { document.onmouseup=null; document.onmousemove=null; }
        }

        // --- SUBTASK FIX ---
        function addSubManual(taskId) {
            if(!db.tasks[taskId].subtasks) db.tasks[taskId].subtasks = [];
            db.tasks[taskId].subtasks.push({ title: "", done: false });
            renderTasks(); saveData();
            setTimeout(() => { const len = db.tasks[taskId].subtasks.length - 1; const el = document.getElementById(`sub-${taskId}-${len}`); if(el) el.focus(); }, 10);
        }
        function handleEnterSub(e, taskId, sIdx) {
            if(e.key === 'Enter') { 
                e.preventDefault(); SFX.confirm(); 
                if(!db.tasks[taskId].subtasks) db.tasks[taskId].subtasks = [];
                db.tasks[taskId].subtasks.splice(sIdx + 1, 0, { title: "", done: false }); 
                renderTasks(); saveData();
                setTimeout(() => { const el = document.getElementById(`sub-${taskId}-${sIdx + 1}`); if(el) el.focus(); }, 10);
            }
        }

        // --- ADMIN & OTHERS ---
        function initAdminPanel() {
            document.getElementById('admin-panel').style.display = 'flex';
            database.ref('users').on('value', (snap) => {
                const users = snap.val() || {};
                const select = document.getElementById('user-selector');
                const currentVal = select.value || viewingID;
                select.innerHTML = `<option value="${ADMIN_ID}">MY WORKSPACE</option>`;
                Object.keys(users).forEach(uid => { if(uid !== ADMIN_ID) select.innerHTML += `<option value="${uid}">${uid}</option>`; });
                select.value = currentVal;
            });
        }
        function switchUserView(target) {
            viewingID = target;
            toggleMatrixMode(myID === ADMIN_ID && viewingID !== ADMIN_ID);
            listenToData(viewingID); SFX.click(); notify(`VIEW: ${target}`);
        }
        function deleteCurrentUser() {
            if(viewingID === ADMIN_ID) return alert("NO.");
            if(!confirm(`DELETE ${viewingID}?`)) return;
            database.ref('users/'+viewingID).remove().then(()=>{ notify("DELETED"); switchUserView(ADMIN_ID); });
        }
        function toggleMatrixMode(s) {
            const b = document.body.classList;
            if(s) { b.add('matrix-mode'); document.querySelectorAll('.scramble-target').forEach(e=>scramble(e)); }
            else b.remove('matrix-mode');
        }
        function scramble(el) {
            const txt = el.innerText, chars="A0B1C2D3E"; let i=0;
            const t = setInterval(()=>{ el.innerText=txt.split('').map((c,j)=>j<i?txt[j]:chars[Math.floor(Math.random()*chars.length)]).join(''); if(i>=txt.length)clearInterval(t); i+=1/2; },30);
        }

        // --- RENDER ---
        function renderTasks() {
            const d = new Date(selectedDate);
            document.getElementById('selectedDateDisplay').innerText = d.toLocaleDateString('tr-TR', { weekday: 'long' });
            document.getElementById('selectedDateSubtitle').innerText = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const cont = document.getElementById('taskContainer');
            const act = document.activeElement, actId = act?act.id:null, s=act?act.selectionStart:0, e=act?act.selectionEnd:0;
            cont.innerHTML = '';
            
            const ids = db.calendar[selectedDate] || [];
            ids.forEach((id, idx) => { const t = db.tasks[id]; if(t) createDOM(id, t, idx); });
            
            if(actId) { const el=document.getElementById(actId); if(el){ el.focus(); if(el.type==='text') el.setSelectionRange(s,e); } }
        }
        function createDOM(id, t, idx) {
            const isLinked = Object.values(db.calendar).filter(l=>l.includes(id)).length>1;
            const card = document.createElement('div'); card.className = `task-card ${t.done?'completed':''}`;
            card.onmouseenter = () => SFX.hover();
            card.innerHTML = `
                ${isLinked?'<div class="shared-badge">LINKED</div>':''}
                <div class="task-header">
                    <div class="main-checkbox ${t.done?'checked':''}" onclick="SFX.click(); toggleTask('${id}')"></div>
                    <input class="task-title-input" id="task-${id}" value="${t.title}" placeholder="TASK..." oninput="updTitle('${id}',this.value)" onkeydown="if(event.key==='Enter'){event.preventDefault();SFX.confirm();addNewTaskManual();}">
                    <div class="btn-group">
                        ${isLinked?`<button class="action-btn unlink-btn" onclick="unlink('${id}',${idx})">[UNLINK]</button>`:''}
                        <button class="action-btn delete-btn" onclick="SFX.click(); removeTask('${id}',${idx})">[DELETE]</button>
                    </div>
                </div>
                <div class="subtask-list" id="subs-${id}"></div>
                <div class="subtask-list" style="border:none;margin-top:5px;"><span style="font-size:0.75rem;opacity:0.6;cursor:pointer;" onclick="SFX.click();addSubManual('${id}')">> ADD DETAIL</span></div>
            `;
            document.getElementById('taskContainer').appendChild(card);
            const subC = card.querySelector(`#subs-${id}`);
            if(t.subtasks) t.subtasks.forEach((sub,sIdx)=>{
                const r = document.createElement('div'); r.className='subtask-item';
                r.innerHTML=`<div class="mini-checkbox ${sub.done?'checked':''}" onclick="SFX.click();toggleSub('${id}',${sIdx})"></div>
                <input class="subtask-input" id="sub-${id}-${sIdx}" value="${sub.title}" oninput="updSub('${id}',${sIdx},this.value)" onkeydown="handleEnterSub(event,'${id}',${sIdx})">
                <span class="sub-del-btn" onclick="SFX.click();removeSub('${id}',${sIdx})">[x]</span>`;
                subC.appendChild(r);
            });
        }

        const uuid=()=>Date.now().toString(36)+Math.random().toString(36).substr(2);
        function updTitle(id,v){db.tasks[id].title=v;saveData();}
        function updSub(id,si,v){db.tasks[id].subtasks[si].title=v;saveData();}
        function toggleSub(id,si){const s=db.tasks[id].subtasks[si];s.done=!s.done;saveData();renderTasks();}
        function toggleTask(id){db.tasks[id].done=!db.tasks[id].done;saveData();renderTasks();}
        function removeTask(id,i){ openModal("DEL","SURE?",[{text:"YES",class:"btn-primary",action:()=>{db.calendar[selectedDate].splice(i,1);if(!Object.values(db.calendar).some(a=>a.includes(id)))delete db.tasks[id];SFX.delete();saveData();renderTasks();}}]); }
        function unlink(id,i){ openModal("UNLINK","METHOD:",[{text:"TODAY",class:"btn-link",action:()=>{db.calendar[selectedDate].splice(i,1);saveData();renderTasks();}},{text:"WIPE",class:"btn-danger",action:()=>{for(let d in db.calendar)if(d!==selectedDate)db.calendar[d]=db.calendar[d].filter(x=>x!==id);saveData();renderTasks();}}]); }
        function removeSub(id,si){ db.tasks[id].subtasks.splice(si,1); SFX.delete(); saveData(); renderTasks(); }
        function addNewTaskManual(){ if(!myID)return; const nid=uuid(); if(!db.tasks)db.tasks={}; db.tasks[nid]={title:"",done:false,subtasks:[]}; if(!db.calendar)db.calendar={}; if(!db.calendar[selectedDate])db.calendar[selectedDate]=[]; db.calendar[selectedDate].push(nid); renderTasks(); saveData(); setTimeout(()=>{document.getElementById(`task-${nid}`).focus()},10); }

        // --- CALENDAR & HELPERS ---
        const calendarGrid=document.getElementById('calendarGrid'), monthDisplay=document.getElementById('monthDisplay');
        function changeMonth(o){currentViewDate.setMonth(currentViewDate.getMonth()+o);renderCalendar();}
        function renderCalendar(){
            calendarGrid.innerHTML=''; const y=currentViewDate.getFullYear(), m=currentViewDate.getMonth();
            monthDisplay.innerText=currentViewDate.toLocaleString('tr-TR',{month:'long',year:'numeric'});
            let fd=new Date(y,m,1).getDay(); if(fd===0)fd=7; fd-=1; const dim=new Date(y,m+1,0).getDate();
            for(let i=0;i<fd;i++)calendarGrid.appendChild(document.createElement('div'));
            for(let i=1;i<=dim;i++){
                const w=document.createElement('div'); w.className='day-wrapper';
                const b=document.createElement('div'); b.className='day-box'; b.innerText=i;
                const s=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                w.dataset.date=s; if(s===selectedDate)b.classList.add('active');
                if((db.calendar[s]||[]).length>0) w.innerHTML+='<div class="connector-bar connector-single"></div>';
                w.onmousedown=()=>{selectedDate=s;renderCalendar();renderTasks();SFX.click();};
                w.appendChild(b); calendarGrid.appendChild(w);
            }
        }
        
        const SFX={
            ctx:null, init:function(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext);if(this.ctx.state==='suspended')this.ctx.resume();},
            tone:function(f,t,d,v=0.1){this.init();const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type=t;o.frequency.setValueAtTime(f,this.ctx.currentTime);g.gain.setValueAtTime(v,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+d);o.connect(g);g.connect(this.ctx.destination);o.start();o.stop(this.ctx.currentTime+d);},
            hover:function(){this.tone(800,'sine',0.03,0.02)}, click:function(){this.tone(1200,'square',0.05,0.05)}, confirm:function(){this.tone(800,'sine',0.1);setTimeout(()=>this.tone(1200,'sine',0.1),50)}, delete:function(){this.tone(150,'sawtooth',0.15)},
            notify:function(){this.tone(1500,'sine',0.1);setTimeout(()=>this.tone(2000,'sine',0.3),100);}
        };
        document.addEventListener('click',()=>SFX.init(),{once:true});
        function notify(m){const c=document.getElementById('toast-container'),t=document.createElement('div');t.className='toast';t.innerHTML=`<span class="toast-prefix">SYS:</span> ${m}`;c.appendChild(t);setTimeout(()=>t.remove(),3000);}
        const modalOverlay=document.getElementById('modal-overlay'), mTitle=document.getElementById('modal-title'), mDesc=document.getElementById('modal-desc'), mAct=document.getElementById('modal-actions');
        function openModal(t,d,btns){ SFX.click(); mTitle.innerText=t;mDesc.innerText=d;mAct.innerHTML=''; const c=document.createElement('button');c.className='modal-btn';c.innerText='CANCEL';c.onclick=()=>{modalOverlay.style.display='none'};mAct.appendChild(c); btns.forEach(b=>{const btn=document.createElement('button');btn.className=`modal-btn ${b.class||''}`;btn.innerText=b.text;btn.onclick=()=>{if(b.action)b.action();modalOverlay.style.display='none'};mAct.appendChild(btn);}); modalOverlay.style.display='flex'; }
        
        // Trail
        const cvs=document.getElementById('trail-canvas'), cx=cvs.getContext('2d'); let w,h,pts=[];
        function rs(){w=window.innerWidth;h=window.innerHeight;cvs.width=w;cvs.height=h;} window.addEventListener('resize',rs); rs();
        document.addEventListener('mousemove',e=>pts.push({x:e.clientX,y:e.clientY,a:1}));
        function anim(){ cx.clearRect(0,0,w,h); for(let i=pts.length-1;i>=0;i--){pts[i].a-=0.05;if(pts[i].a<=0)pts.splice(i,1);} if(pts.length>1){cx.beginPath();cx.moveTo(pts[pts.length-1].x,pts[pts.length-1].y); for(let i=pts.length-2;i>=0;i--){const p=pts[i]; cx.lineTo(p.x,p.y);} cx.strokeStyle=`rgba(255,255,255,0.5)`;cx.stroke();} requestAnimationFrame(anim); } anim();
        
        renderCalendar();
    </script>
</body>
</html>
